<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Laporan Foto - SDN Kebon Pala 02 Pagi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* Latar belakang baru: putih kebiruan dengan dominan putih */
            background: linear-gradient(to bottom, #f0f9ff, #ffffff);
        }
        .glassmorphism {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        .tab-button.active {
            background-color: rgba(14, 165, 233, 0.8);
            color: white;
            font-weight: 600;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Styling untuk notifikasi custom */
        #notification {
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
            transform: translateY(-100px);
            opacity: 0;
        }
        #notification.show {
            transform: translateY(20px);
            opacity: 1;
        }
    </style>
</head>
<body class="text-gray-700">

    <!-- Elemen Notifikasi -->
    <div id="notification" class="fixed top-0 left-1/2 -translate-x-1/2 z-50 p-4 rounded-lg shadow-lg text-white font-semibold">
        <p id="notification-message"></p>
    </div>

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.1);">Laporan Foto SDN Kebon Pala 02 Pagi</h1>
        </header>

        <nav class="glassmorphism p-4 mb-8 flex flex-wrap justify-center gap-2 md:gap-4">
            <button class="tab-button py-2 px-4 rounded-lg transition-all duration-300 hover:bg-sky-200/50 active" onclick="showTab('fotoUpacara')">Foto Upacara</button>
            <button class="tab-button py-2 px-4 rounded-lg transition-all duration-300 hover:bg-sky-200/50" onclick="showTab('fotoRabu')">Foto Rabu</button>
            <button class="tab-button py-2 px-4 rounded-lg transition-all duration-300 hover:bg-sky-200/50" onclick="showTab('rekapUpacara'); loadRekap('upacara');">Rekap Upacara</button>
            <button class="tab-button py-2 px-4 rounded-lg transition-all duration-300 hover:bg-sky-200/50" onclick="showTab('rekapRabu'); loadRekap('rabu');">Rekap Foto Rabu</button>
        </nav>

        <main>
            <!-- Form Foto Upacara -->
            <div id="fotoUpacara" class="tab-content glassmorphism p-6 md:p-8">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800 text-center">Form Laporan Foto Upacara</h2>
                <form id="formUpacara" class="space-y-6">
                    <input type="hidden" id="upacara-id" name="id">
                    <input type="hidden" id="upacara-fileId" name="fileId">
                    <div>
                        <label for="upacara-tanggal" class="block mb-2 text-sm font-medium">Tanggal</label>
                        <input type="date" id="upacara-tanggal" name="tanggal" class="bg-white/80 border border-gray-300 text-gray-800 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                    </div>
                    <div>
                        <label for="upacara-nama" class="block mb-2 text-sm font-medium">Nama</label>
                        <input type="text" id="upacara-nama" name="nama" class="bg-white/80 border border-gray-300 text-gray-800 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                    </div>
                    <div>
                        <label for="upacara-status" class="block mb-2 text-sm font-medium">Status</label>
                        <select id="upacara-status" name="status" class="bg-white/80 border border-gray-300 text-gray-800 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                            <option value="">Pilih Status</option>
                            <option value="ASN">ASN</option>
                            <option value="Non ASN">Non ASN</option>
                        </select>
                    </div>
                    <div>
                        <label for="upacara-kegiatan" class="block mb-2 text-sm font-medium">Kegiatan</label>
                        <input type="text" id="upacara-kegiatan" name="kegiatan" class="bg-white/80 border border-gray-300 text-gray-800 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="Contoh: Upacara HUT RI" required>
                    </div>
                    <div>
                        <label for="upacara-foto" class="block mb-2 text-sm font-medium">Upload Foto</label>
                        <input type="file" id="upacara-foto" name="foto" class="block w-full text-sm text-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-sky-500 file:text-white hover:file:bg-sky-600 cursor-pointer" required>
                        <img id="upacara-preview" class="mt-4 rounded-lg max-w-xs hidden" alt="Preview Foto">
                    </div>
                    <div class="flex justify-end space-x-4">
                        <button type="submit" id="upacara-submit-btn" class="text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-800 font-medium rounded-lg text-sm w-full sm:w-auto px-5 py-2.5 text-center">Kirim</button>
                        <button type="button" id="upacara-update-btn" class="hidden text-white bg-green-600 hover:bg-green-700 focus:ring-4 focus:outline-none focus:ring-green-800 font-medium rounded-lg text-sm w-full sm:w-auto px-5 py-2.5 text-center" onclick="updateData('upacara')">Simpan</button>
                    </div>
                </form>
            </div>

            <!-- Form Foto Rabu -->
            <div id="fotoRabu" class="tab-content glassmorphism p-6 md:p-8 hidden">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800 text-center">Form Laporan Foto Rabu</h2>
                <form id="formRabu" class="space-y-6">
                    <input type="hidden" id="rabu-id" name="id">
                    <input type="hidden" id="rabu-fileId" name="fileId">
                    <div>
                        <label for="rabu-tanggal" class="block mb-2 text-sm font-medium">Tanggal</label>
                        <input type="date" id="rabu-tanggal" name="tanggal" class="bg-white/80 border border-gray-300 text-gray-800 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                    </div>
                    <div>
                        <label for="rabu-nama" class="block mb-2 text-sm font-medium">Nama</label>
                        <input type="text" id="rabu-nama" name="nama" class="bg-white/80 border border-gray-300 text-gray-800 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                    </div>
                    <div>
                        <label for="rabu-status" class="block mb-2 text-sm font-medium">Status</label>
                        <select id="rabu-status" name="status" class="bg-white/80 border border-gray-300 text-gray-800 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                            <option value="">Pilih Status</option>
                            <option value="ASN">ASN</option>
                            <option value="Non ASN">Non ASN</option>
                        </select>
                    </div>
                    <div>
                        <label for="rabu-transportasi" class="block mb-2 text-sm font-medium">Transportasi</label>
                        <select id="rabu-transportasi" name="transportasi" class="bg-white/80 border border-gray-300 text-gray-800 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                            <option value="">Pilih Transportasi</option>
                            <option>Transjakarta</option>
                            <option>MRT</option>
                            <option>LRT Jakarta</option>
                            <option>LRT Jabodebek</option>
                            <option>KRL Jabodetabek</option>
                            <option>Kereta Bandara</option>
                            <option>Bus/Angkot Reguler</option>
                            <option>Angkutan antar jemput karyawan/pegawai</option>
                            <option>Kapal</option>
                            <option>Jalan Kaki / Bersepeda</option>
                        </select>
                    </div>
                    <div>
                        <label for="rabu-foto" class="block mb-2 text-sm font-medium">Upload Foto</label>
                        <input type="file" id="rabu-foto" name="foto" class="block w-full text-sm text-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-sky-500 file:text-white hover:file:bg-sky-600 cursor-pointer" required>
                        <img id="rabu-preview" class="mt-4 rounded-lg max-w-xs hidden" alt="Preview Foto">
                    </div>
                    <div class="flex justify-end space-x-4">
                        <button type="submit" id="rabu-submit-btn" class="text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-800 font-medium rounded-lg text-sm w-full sm:w-auto px-5 py-2.5 text-center">Kirim</button>
                        <button type="button" id="rabu-update-btn" class="hidden text-white bg-green-600 hover:bg-green-700 focus:ring-4 focus:outline-none focus:ring-green-800 font-medium rounded-lg text-sm w-full sm:w-auto px-5 py-2.5 text-center" onclick="updateData('rabu')">Simpan</button>
                    </div>
                </form>
            </div>

            <!-- Rekap Upacara -->
            <div id="rekapUpacara" class="tab-content glassmorphism p-6 md:p-8 hidden">
                 <h2 class="text-2xl font-semibold mb-6 text-gray-800 text-center">Rekap Laporan Foto Upacara</h2>
                 <div class="mb-4">
                    <input type="text" id="searchUpacara" onkeyup="filterTable('upacara')" placeholder="Cari laporan..." class="bg-white/80 border border-gray-300 text-gray-800 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 placeholder-gray-500">
                 </div>
                 <div class="overflow-x-auto">
                    <table id="tableUpacara" class="w-full text-sm text-left text-gray-600">
                        <thead class="text-xs text-gray-700 uppercase bg-sky-100">
                            <tr>
                                <th scope="col" class="px-6 py-3">ID</th>
                                <th scope="col" class="px-6 py-3">Tanggal</th>
                                <th scope="col" class="px-6 py-3">Nama</th>
                                <th scope="col" class="px-6 py-3">Status</th>
                                <th scope="col" class="px-6 py-3">Kegiatan</th>
                                <th scope="col" class="px-6 py-3">Link Foto</th>
                                <th scope="col" class="px-6 py-3">Aksi</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                 </div>
            </div>

            <!-- Rekap Rabu -->
            <div id="rekapRabu" class="tab-content glassmorphism p-6 md:p-8 hidden">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800 text-center">Rekap Laporan Foto Rabu</h2>
                 <div class="mb-4">
                    <input type="text" id="searchRabu" onkeyup="filterTable('rabu')" placeholder="Cari laporan..." class="bg-white/80 border border-gray-300 text-gray-800 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 placeholder-gray-500">
                 </div>
                 <div class="overflow-x-auto">
                    <table id="tableRabu" class="w-full text-sm text-left text-gray-600">
                        <thead class="text-xs text-gray-700 uppercase bg-sky-100">
                            <tr>
                                <th scope="col" class="px-6 py-3">ID</th>
                                <th scope="col" class="px-6 py-3">Tanggal</th>
                                <th scope="col" class="px-6 py-3">Nama</th>
                                <th scope="col" class="px-6 py-3">Status</th>
                                <th scope="col" class="px-6 py-3">Transportasi</th>
                                <th scope="col" class="px-6 py-3">Link Foto</th>
                                <th scope="col" class="px-6 py-3">Aksi</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                 </div>
            </div>
        </main>
    </div>

    <!-- Modal Konfirmasi Hapus -->
    <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center hidden z-50">
        <div class="glassmorphism p-8 max-w-sm mx-auto">
            <h3 class="text-lg font-bold mb-4 text-gray-900">Konfirmasi Hapus</h3>
            <p class="text-gray-600 mb-6">Apakah Anda yakin akan menghapus laporan ini?</p>
            <div class="flex justify-end gap-4">
                <button id="cancelDelete" class="py-2 px-4 bg-gray-300 hover:bg-gray-400 rounded-lg text-gray-800">Tidak</button>
                <button id="confirmDelete" class="py-2 px-4 bg-red-600 hover:bg-red-700 rounded-lg text-white">Hapus</button>
            </div>
        </div>
    </div>
    
    <!-- Loader Modal -->
    <div id="loaderModal" class="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center hidden z-50">
        <div class="loader"></div>
    </div>


    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxQje4od76e9DuvQcDhjhmO88L729fKQHlN_y_tdMEArs1R5qMkl-ocRDpXADQbOMUJNA/exec'; // <-- JANGAN LUPA GANTI URL INI

        // Fungsi Notifikasi
        function showNotification(message, type = 'success') {
            const notif = document.getElementById('notification');
            const notifMessage = document.getElementById('notification-message');
            
            notifMessage.textContent = message;
            notif.className = 'fixed top-0 left-1/2 -translate-x-1/2 z-50 p-4 rounded-lg shadow-lg text-white font-semibold'; // Reset class
            if (type === 'success') {
                notif.classList.add('bg-green-500');
            } else {
                notif.classList.add('bg-red-500');
            }
            
            notif.classList.add('show');
            
            setTimeout(() => {
                notif.classList.remove('show');
            }, 3000);
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.getElementById(tabName).classList.remove('hidden');
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`button[onclick*="${tabName}"]`).classList.add('active');
        }

        function showLoader() { document.getElementById('loaderModal').classList.remove('hidden'); }
        function hideLoader() { document.getElementById('loaderModal').classList.add('hidden'); }

        document.getElementById('upacara-foto').addEventListener('change', (e) => handleImagePreview(e, 'upacara-preview'));
        document.getElementById('rabu-foto').addEventListener('change', (e) => handleImagePreview(e, 'rabu-preview'));
        
        function handleImagePreview(event, previewId) {
            const preview = document.getElementById(previewId);
            if (event.target.files && event.target.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                }
                reader.readAsDataURL(event.target.files[0]);
            } else {
                 preview.classList.add('hidden');
            }
        }

        document.getElementById('formUpacara').addEventListener('submit', (e) => handleFormSubmit(e, 'upacara'));
        document.getElementById('formRabu').addEventListener('submit', (e) => handleFormSubmit(e, 'rabu'));

        function handleFormSubmit(e, type) {
            e.preventDefault();
            const form = e.target;
            const file = form.foto.files[0];
            if (!file) {
                showNotification('Silakan pilih file foto.', 'error');
                return;
            }
            showLoader();
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => {
                const fileData = {
                    base64: reader.result.split(',')[1],
                    type: file.type,
                    name: file.name
                };

                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                data.id = `ID-${type.toUpperCase()}-${Date.now()}`;
                delete data.foto;
                
                const payload = { action: 'create', type: type, data: data, fileData: fileData };

                fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) })
                .then(res => res.json())
                .then(result => {
                    hideLoader();
                    if(result.success) {
                        showNotification('Laporan Foto Berhasil Di Kirim');
                        form.reset();
                        document.getElementById(`${type}-preview`).classList.add('hidden');
                        // Pindah ke tab rekap dan muat data baru
                        const rekapTab = type === 'upacara' ? 'rekapUpacara' : 'rekapRabu';
                        showTab(rekapTab);
                        loadRekap(type);
                    } else {
                        throw new Error(result.message || 'Gagal mengirim laporan.');
                    }
                })
                .catch(err => {
                    hideLoader();
                    console.error('Error:', err);
                    showNotification('Terjadi kesalahan: ' + err.message, 'error');
                });
            };
        }
        
        function loadRekap(type) {
            showLoader();
            fetch(`${SCRIPT_URL}?action=read&type=${type}`)
                .then(res => res.json())
                .then(data => {
                    const tableBody = document.querySelector(`#table${type.charAt(0).toUpperCase() + type.slice(1)} tbody`);
                    tableBody.innerHTML = '';
                    if (data.success && data.data.length > 0) {
                        data.data.forEach(row => {
                            const tr = document.createElement('tr');
                            tr.className = "border-b border-gray-200 hover:bg-sky-50";
                            tr.innerHTML = `
                                <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${row.id}</td>
                                <td class="px-6 py-4">${row.tanggal}</td>
                                <td class="px-6 py-4">${row.nama}</td>
                                <td class="px-6 py-4">${row.status}</td>
                                <td class="px-6 py-4">${type === 'upacara' ? row.kegiatan : row.transportasi}</td>
                                <td class="px-6 py-4"><a href="${row.foto}" target="_blank" class="text-blue-600 hover:underline">Lihat Foto</a></td>
                                <td class="px-6 py-4 flex gap-2">
                                    <button onclick="editData('${type}', '${row.id}')" class="font-medium text-yellow-600 hover:underline">Edit</button>
                                    <button onclick="confirmDeleteData('${type}', '${row.id}', '${row.fileId}')" class="font-medium text-red-600 hover:underline">Hapus</button>
                                </td>
                            `;
                            tableBody.appendChild(tr);
                        });
                    } else {
                         tableBody.innerHTML = `<tr><td colspan="7" class="text-center py-4">${data.message || 'Tidak ada data'}</td></tr>`;
                    }
                    hideLoader();
                })
                .catch(err => {
                    hideLoader();
                    console.error('Error loading data:', err);
                    showNotification('Gagal memuat data rekap.', 'error');
                });
        }

        function filterTable(type) {
            const input = document.getElementById(`search${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const filter = input.value.toUpperCase();
            const table = document.getElementById(`table${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const tr = table.getElementsByTagName("tr");

            for (let i = 1; i < tr.length; i++) {
                let td = tr[i].getElementsByTagName("td");
                let match = false;
                for (let j = 0; j < td.length - 2; j++) {
                    if (td[j] && td[j].textContent.toUpperCase().indexOf(filter) > -1) {
                        match = true;
                        break;
                    }
                }
                tr[i].style.display = match ? "" : "none";
            }
        }

        function editData(type, id) {
            showLoader();
            fetch(`${SCRIPT_URL}?action=read&type=${type}&id=${id}`)
                .then(res => res.json())
                .then(result => {
                    hideLoader();
                    if(result.success && result.data) {
                        const data = result.data;
                        showTab(type === 'upacara' ? 'fotoUpacara' : 'fotoRabu');
                        document.getElementById(`${type}-id`).value = data.id;
                        document.getElementById(`${type}-tanggal`).value = data.tanggal;
                        document.getElementById(`${type}-nama`).value = data.nama;
                        document.getElementById(`${type}-status`).value = data.status;
                        if (type === 'upacara') {
                            document.getElementById('upacara-kegiatan').value = data.kegiatan;
                        } else {
                            document.getElementById('rabu-transportasi').value = data.transportasi;
                        }
                        document.getElementById(`${type}-fileId`).value = data.fileId;
                        
                        const preview = document.getElementById(`${type}-preview`);
                        preview.src = data.foto;
                        preview.classList.remove('hidden');

                        document.getElementById(`${type}-submit-btn`).classList.add('hidden');
                        document.getElementById(`${type}-update-btn`).classList.remove('hidden');
                        document.getElementById(`${type}-foto`).required = false;

                    } else {
                        showNotification('Data tidak ditemukan.', 'error');
                    }
                })
                .catch(err => {
                    hideLoader();
                    showNotification('Gagal mengambil data untuk diedit.', 'error');
                    console.error(err);
                });
        }
        
        function updateData(type) {
            const form = document.getElementById(`form${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const fileInput = document.getElementById(`${type}-foto`);
            const file = fileInput.files[0];
            showLoader();

            const processUpdate = (fileData = null) => {
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                delete data.foto;
                const payload = { action: 'update', type: type, data: data, fileData: fileData };

                fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) })
                .then(res => res.json())
                .then(result => {
                    hideLoader();
                    if(result.success) {
                        showNotification('Laporan Berhasil Diperbarui');
                        form.reset();
                        document.getElementById(`${type}-preview`).classList.add('hidden');
                        document.getElementById(`${type}-submit-btn`).classList.remove('hidden');
                        document.getElementById(`${type}-update-btn`).classList.add('hidden');
                        fileInput.required = true;
                        showTab(type === 'upacara' ? 'rekapUpacara' : 'rekapRabu');
                        loadRekap(type);
                    } else {
                        throw new Error(result.message || 'Gagal memperbarui laporan.');
                    }
                })
                .catch(err => {
                    hideLoader();
                    showNotification('Terjadi kesalahan: ' + err.message, 'error');
                    console.error(err);
                });
            };

            if (file) {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    const fileData = { base64: reader.result.split(',')[1], type: file.type, name: file.name };
                    processUpdate(fileData);
                };
            } else {
                processUpdate(null);
            }
        }

        function confirmDeleteData(type, id, fileId) {
            const modal = document.getElementById('deleteModal');
            modal.classList.remove('hidden');
            const confirmBtn = document.getElementById('confirmDelete');
            const cancelBtn = document.getElementById('cancelDelete');

            const confirmHandler = () => {
                modal.classList.add('hidden');
                deleteData(type, id, fileId);
                confirmBtn.removeEventListener('click', confirmHandler);
            };
            const cancelHandler = () => modal.classList.add('hidden');
            
            confirmBtn.onclick = confirmHandler;
            cancelBtn.onclick = cancelHandler;
        }

        function deleteData(type, id, fileId) {
            showLoader();
            const payload = { action: 'delete', type, id, fileId };
            fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) })
            .then(res => res.json())
            .then(result => {
                hideLoader();
                if (result.success) {
                    showNotification('Laporan Berhasil Dihapus');
                    loadRekap(type);
                } else {
                    throw new Error(result.message || 'Gagal menghapus laporan.');
                }
            })
            .catch(err => {
                hideLoader();
                showNotification('Terjadi kesalahan: ' + err.message, 'error');
                console.error(err);
            });
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            showTab('fotoUpacara');
        });

    </script>
</body>
</html>
